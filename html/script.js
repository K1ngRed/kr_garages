

let currentGarage = null;let currentVehicles = [];let selectedVehicle = null;let owners = [];let privateGaragesCache = [];let returnToModalId = null;let pendingDeleteGarageId = null;let autoRefreshTimer = null;let impoundFormData = null;let cachedGaragesForTransfer = null;let cacheTimestamp = 0;const CACHE_DURATION = 60000;const DOM ={};const DEFAULT_LOCALE ={appTitle: 'KR Garajes',noVehicles: 'No tienes vehÃ­culos de este tipo.',noPrivateGarages: 'No hay garajes privados',loadingPlayers: 'Cargando jugadores...',noPlayersOnline: 'No hay jugadores en lÃ­nea',loading: 'Cargando...',pleaseFillAll: 'Por favor completa todos los campos requeridos',edit: 'Editar',delete: 'Eliminar',idLabel: 'ID:',selectPlayer: 'Seleccionar jugador',selectGarage: 'Seleccionar garaje',noPlayersNearby: 'No hay jugadores cerca',noGaragesAvailable: 'No hay garajes disponibles',deleting: 'Eliminando...',storing: 'Guardando...',spawned: 'VehÃ­culo sacado del garaje',stored: 'VehÃ­culo guardado',errorFetching: 'Error al obtener datos',garageNamePlaceholder: 'Nombre del garaje',garageTypePlaceholder: 'Tipo de garaje',ownerNotFound: 'Jugador objetivo no encontrado',invalidPlate: 'Placa invÃ¡lida',plateTooLong: 'Placa demasiado larga',noSelection: 'Nada seleccionado',confirm: 'Confirmar',cancel: 'Cancelar',destroyed: 'Destruido',abandoned: 'Abandonado',outsideGarage: 'Ya estÃ¡ fuera',otherGarage: 'Otro garaje',thisGarage: 'Este garaje',fuel: 'Combustible',engine: 'Motor',body: 'CarrocerÃ­a',repair: 'Reparar',repairAndUse: 'Reparar y Usar',recoverAndUse: 'Recuperar y Usar',vehicleOutside: 'VehÃ­culo fuera',useVehicle: 'Usar VehÃ­culo',transfer: 'Transferir',repairVehicle: 'Reparar VehÃ­culo',recoverVehicle: 'Recuperar VehÃ­culo',repairConfirmText: 'Este vehÃ­culo estÃ¡ destruido. Â¿Deseas repararlo por ${cost}y usarlo?',recoverConfirmText: 'Tu vehÃ­culo estÃ¡ spawneado en algÃºn lugar del mapa. Â¿Deseas recuperarlo ${cost}y traerlo aquÃ­? El vehÃ­culo original serÃ¡ eliminado.',free: 'gratis',vehicleInOtherGarage: 'Este vehÃ­culo estÃ¡ en otro garaje. Debes transferirlo primero.',onlyTransferFromThisGarage: 'Solo puedes transferir vehÃ­culos que estÃ©n guardados en este garaje',repairTitle: 'Reparar'};let LOCALE = DEFAULT_LOCALE;let currentLocale = 'es';async function loadLocale(lang){try{const res = await fetch(`locales/${lang}.json`);if (res.ok){const json = await res.json();LOCALE = Object.assign({},DEFAULT_LOCALE,json ||{});currentLocale = lang;}else{const fallback = await fetch('locales/es.json');if (fallback.ok){const json = await fallback.json();LOCALE = Object.assign({},DEFAULT_LOCALE,json ||{});}}}catch (e){}}loadLocale('es');const RES_NAME = (typeof GetParentResourceName === "function")
? GetParentResourceName()
: "kr_garages";function nuiPost(route,payload){return fetch(`https://${RES_NAME}/${route}`,{method: 'POST',headers:{'Content-Type': 'application/json'},body: JSON.stringify(payload ||{})});}function escapeHtml(text){if (!text) return '';const div = document.createElement('div');div.textContent = text;return div.innerHTML;}function hideAllModals(){document.querySelectorAll('.modal-overlay').forEach(modal =>{modal.classList.add('hidden');});}function showOnlyModal(modalId){hideAllModals();const modal = document.getElementById(modalId);if (modal){modal.classList.remove('hidden');}}function getVisibleModalId(){const modals = document.querySelectorAll('.modal-overlay');for (let modal of modals){if (!modal.classList.contains('hidden')){return modal.id;}}return null;}let currentImpound = null;let impoundVehicles = [];let isImpoundFullAdmin = false;let isImpoundAdminView = false;window.addEventListener('message',(event) =>{const data = event.data;switch(data.action){case 'openGarage':

if (data.locale && data.locale !== currentLocale){loadLocale(data.locale).then(() =>{openGarage(data.garage,data.vehicles);});}else{openGarage(data.garage,data.vehicles);}break;case 'openPrivateGarages':
openPrivateGarages();break;case 'openImpound':

if (data.locale && data.locale !== currentLocale){loadLocale(data.locale).then(() =>{openImpound(data.impound,data.vehicles,data.releaseFee,data.loading,data.isAdmin);});}else{openImpound(data.impound,data.vehicles,data.releaseFee,data.loading,data.isAdmin);}break;case 'updateImpoundVehicles':

updateImpoundVehiclesList(data.vehicles,data.isFullAdmin,data.isAdminView);break;case 'openImpoundForm':

openImpoundForm(data);break;case 'refreshVehicles':
if (data.vehicles){currentVehicles = data.vehicles;renderVehicles(data.vehicles,{garageId: currentGarage?.id,garageType: currentGarage?.type || 'car'});updateVehicleCount();hideAllModals();cachedGaragesForTransfer = null;cacheTimestamp = 0;}break;case 'forceClose':

document.getElementById('app').classList.add('hidden');document.getElementById('garageMain').classList.add('hidden');document.getElementById('privateGaragesMain').classList.add('hidden');document.getElementById('impoundMain')?.classList.add('hidden');stopAutoRefresh();currentGarage = null;currentImpound = null;selectedVehicle = null;break;case 'close':
case 'closeUI':
case 'hide':
closeUI();break;}});async function loadVehicles(){if (!currentGarage || !currentGarage.id){return;}try{const response = await nuiPost('getVehicles',{garageId: currentGarage.id,garageType: (currentGarage.type || 'car')});const list = await response.json().catch(() => []);currentVehicles = Array.isArray(list) ? list : [];renderVehicles(currentVehicles,{garageId: currentGarage.id,garageType: currentGarage.type || 'car'});updateVehicleCount();}catch (e){}}function openGarage(garage,vehicles){currentGarage = garage;currentVehicles = Array.isArray(vehicles) ? vehicles : [];selectedVehicle = null;startAutoRefresh();document.getElementById('app').classList.remove('hidden');document.getElementById('garageMain').classList.remove('hidden');document.getElementById('privateGaragesMain').classList.add('hidden');document.getElementById('garageName').textContent = garage.name;const garageIconEl = document.getElementById('garageIcon');if (garageIconEl){garageIconEl.innerHTML = getGarageIcon(garage.type || 'car');}const footerActionsEl = document.getElementById('garageFooterActions');if (footerActionsEl){const isPrivateGarage = garage.id && typeof garage.id === 'number' && garage.garageType === 'private';const canEdit = garage.canEdit === true || garage.isOwner === true;if (isPrivateGarage && canEdit){footerActionsEl.innerHTML = `
<button class="btn btn-primary" onclick="openAccessModalFromGarage()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:6px;vertical-align:middle;"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
Dar Acceso
</button>
`;}else{footerActionsEl.innerHTML = '';}}renderVehicles(vehicles || [],{garageId: garage.id,garageType: garage.type || 'car'});updateVehicleCount();}function showVehiclesLoading(){const cont = DOM.vehiclesList || document.getElementById('vehiclesList') || document.getElementById('vehicles-list');if (!cont) return;cont.innerHTML = `<div class="loading-state">
<div class="loading-spinner"></div>
<p>${LOCALE.loading || 'Cargando...'}</p>
</div>`;}function renderVehicles(vehicles,ctx){const cont = DOM.vehiclesList || document.getElementById('vehiclesList') || document.getElementById('vehicles-list');if (!cont) return;while (cont.firstChild) cont.removeChild(cont.firstChild);if (!Array.isArray(vehicles) || vehicles.length === 0){const emptyIcon = getGarageIcon(ctx?.garageType || currentGarage?.type || 'car');cont.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${emptyIcon}</div><p>${LOCALE.noVehicles}</p></div>`;return;}const fragment = document.createDocumentFragment();vehicles.forEach(v =>{const card = document.createElement('div');card.className = 'vehicle-card';if (v.isDestroyed){card.classList.add('vehicle-destroyed');}else if (v.existsInWorld){card.classList.add('vehicle-in-world');}else if (v.isInCurrentGarage === false){card.classList.add('vehicle-in-other-garage');}else if (v.inGarage == 0){card.classList.add('vehicle-outside-garage');}const props = v.props ||{};let modelName = (props.modelName || props.modelLabel || props.model || v.vehicle || 'VehÃ­culo').toString();if (/^-?\d+$/.test(modelName) || 
/^vehicle#-?\d+$/i.test(modelName) ||
modelName.toLowerCase() === 'unknown' || 
modelName.toLowerCase() === 'vehicle'){modelName = 'VehÃ­culo Custom';}const fuel = v.isDestroyed ? 0 : Math.max(0,Math.min(100,Math.round((v.fuel || 0))));const engine = v.isDestroyed ? 0 : Math.max(0,Math.min(100,Math.round(((v.engine || 1000)/10))));const body = v.isDestroyed ? 0 : Math.max(0,Math.min(100,Math.round(((v.body || 1000)/10))));const ICONS ={destroyed: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',abandoned: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',outside: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 17l4 4 4-4m-4-5v9"/><path d="M20.88 18.09A5 5 0 0018 9h-1.26A8 8 0 103 16.29"/></svg>',otherGarage: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>',thisGarage: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>',impounded: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4M12 16h.01"/></svg>'};let where = '';let locationIcon = '';if (v.isImpounded){where = v.impoundName || LOCALE.impounded || 'Incautado';locationIcon = ICONS.impounded;card.classList.add('vehicle-impounded');}else if (v.isDestroyed){where = LOCALE.destroyed || 'Destruido';locationIcon = ICONS.destroyed;}else if (v.inGarage == 1){if (v.isInCurrentGarage === false){where = v.garageLocationName || LOCALE.otherGarage || 'Otro garaje';locationIcon = ICONS.otherGarage;}else{where = currentGarage && currentGarage.name || LOCALE.thisGarage || 'Este garaje';locationIcon = ICONS.thisGarage;}}else if (v.isNearby){where = LOCALE.outsideGarage || 'Ya estÃ¡ fuera';locationIcon = ICONS.outside;}else if (v.isAbandoned){where = LOCALE.abandoned || 'Abandonado';locationIcon = ICONS.abandoned;}else{where = LOCALE.abandoned || 'Abandonado';locationIcon = ICONS.abandoned;}const color = props.color1 || props.pearlescentColor || [255,255,255];const colorStyle = Array.isArray(color) ? `rgb(${color[0]},${color[1]},${color[2]})` : '#ffffff';const imageUrl = getVehicleImageUrl(props);const fallbackImageUrl = getPlaceholderImageEscaped();const vehicleIcon = getVehicleIcon(props);const modelLabel = props.modelLabel || modelName;card.innerHTML = `
<div class="vehicle-card-header" onclick="toggleVehicleDetails(event,this.parentElement)">
<div class="vehicle-card-left">
<div class="vehicle-image-wrapper">
<img src="${imageUrl}" alt="" class="vehicle-thumbnail" 
onerror="this.onerror=null;this.src='${fallbackImageUrl}';" />
</div>
<div class="vehicle-info">
<h3>${modelName}</h3>
<span class="vehicle-plate">${v.plate || ''}</span>
</div>
</div>
<div class="vehicle-location ${v.isInCurrentGarage === false ? 'location-other-garage' : ''}">
<span class="location-icon">${locationIcon}</span>
<span>${where}</span>
${v.repairCost > 0 && v.isInCurrentGarage === true && v.inGarage == 1 ? `
<button class="btn btn-repair btn-small" onclick="event.stopPropagation();repairOnly(event,${vehicles.indexOf(v)})" title="${LOCALE.repair || 'Reparar'}$${v.repairCost}">
<svg fill="currentColor" viewBox="0 0 20 20" width="14" height="14"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg>
</button>
` : ''}</div>
</div>
<div class="vehicle-details" style="display: none;">
<div class="vehicle-stats">
<div class="stat-item"><span class="stat-label">${LOCALE.fuel || 'Combustible'}</span><div class="stat-bar"><div class="stat-bar-fill ${getStatClass(fuel)}" style="width:${fuel}%"></div></div><span class="stat-value">${fuel}%</span></div>
<div class="stat-item"><span class="stat-label">${LOCALE.engine || 'Motor'}</span><div class="stat-bar"><div class="stat-bar-fill ${getStatClass(engine)}" style="width:${engine}%"></div></div><span class="stat-value">${engine}%</span></div>
<div class="stat-item"><span class="stat-label">${LOCALE.body || 'CarrocerÃ­a'}</span><div class="stat-bar"><div class="stat-bar-fill ${getStatClass(body)}" style="width:${body}%"></div></div><span class="stat-value">${body}%</span></div>
</div>
<div class="vehicle-actions">
${(() =>{const isInGarage = v.inGarage == 1;const isDestroyed = v.isDestroyed;const isNearby = v.isNearby;const isAbandoned = v.isAbandoned;const isInThisGarage = v.isInCurrentGarage === true;const hasNoGarageAssigned = isInGarage && !v.garageLocationName;const isImpounded = v.isImpounded;if (isImpounded){return `<button class="btn btn-impound" onclick="gpsToImpound(event,${vehicles.indexOf(v)})">
<svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
${LOCALE.gpsToImpound || 'GPS al DepÃ³sito'}</button>`;}let btnClass = 'btn-primary';let btnDisabled = '';let btnText = LOCALE.useVehicle || 'Usar VehÃ­culo';if (isDestroyed){btnClass = 'btn-danger';btnText = `${LOCALE.repairAndUse || 'Reparar y Usar'}$${v.repairCost || 0}`;if (!isInThisGarage){btnDisabled = `disabled title="${LOCALE.vehicleInOtherGarage || 'Este vehÃ­culo estÃ¡ en otro garaje.'}"`;}}else if (isNearby){btnClass = 'btn-warning';btnDisabled = `disabled title="${LOCALE.vehicleAlreadyOut || 'Este vehÃ­culo ya estÃ¡ en el mundo. Ve a buscarlo.'}"`;btnText = LOCALE.goFindVehicle || 'Ir a buscar';}else if (isAbandoned){btnClass = 'btn-warning';btnText = `${LOCALE.recoverToGarage || 'Traer al garaje'}$${v.repairCost || 0}`;}else if (isInThisGarage){btnClass = 'btn-primary';btnText = LOCALE.useVehicle || 'Usar VehÃ­culo';}else if (hasNoGarageAssigned){btnClass = 'btn-secondary';btnDisabled = `disabled title="${LOCALE.transferFirst || 'Transfiere este vehÃ­culo a un garaje primero'}"`;btnText = LOCALE.transferFirst || 'Transferir primero';}else if (isInGarage && v.garageLocationName){btnClass = 'btn-secondary';btnDisabled = `disabled title="${LOCALE.vehicleInOtherGarage || 'Este vehÃ­culo estÃ¡ en otro garaje.'}"`;btnText = `En: ${v.garageLocationName}`;}return `<button class="btn ${btnClass}" onclick="selectAndSpawn(event,${vehicles.indexOf(v)})" ${btnDisabled}>
<svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>
${btnText}</button>`;})()}${!v.isImpounded && v.inGarage == 1 && v.repairCost > 0 && v.isInCurrentGarage === true && !v.isDestroyed ? `
<button class="btn btn-repair" onclick="repairOnly(event,${vehicles.indexOf(v)})">
<svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg>
${LOCALE.repair || 'Reparar'}$${v.repairCost}</button>
` : ''}${(() =>{if (v.isImpounded){return '';}const isInGarage = v.inGarage == 1;const isInThisGarage = v.isInCurrentGarage === true;const isInOtherGarage = isInGarage && !isInThisGarage;const isOutside = !isInGarage;const transferPrice = 500;if (v.isDestroyed || v.isNearby || v.isAbandoned || isOutside){return `<button class="btn btn-secondary" disabled title="${LOCALE.vehicleMustBeInGarage || 'El vehÃ­culo debe estar guardado para transferir'}">
<svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16"><path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z"/></svg>
${LOCALE.transfer || 'Transferir'}</button>`;}else if (isInOtherGarage){return `<button class="btn btn-warning" onclick="bringVehicleHere(event,${vehicles.indexOf(v)})">
<svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd"/></svg>
${LOCALE.bringHere || 'Traer aquÃ­'}$${transferPrice}</button>`;}else if (isInThisGarage){return `<button class="btn btn-secondary" onclick="selectAndTransfer(event,${vehicles.indexOf(v)})">
<svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16"><path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z"/></svg>
${LOCALE.transfer || 'Transferir'}$${transferPrice}</button>`;}else{return `<button class="btn btn-secondary" disabled title="${LOCALE.cannotTransfer || 'No se puede transferir'}">
<svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16"><path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z"/></svg>
${LOCALE.transfer || 'Transferir'}</button>`;}})()}</div>
</div>
`;fragment.appendChild(card);});cont.appendChild(fragment);}async function openPrivateGarages(){document.getElementById('app').classList.remove('hidden');document.getElementById('garageMain').classList.add('hidden');document.getElementById('privateGaragesMain').classList.remove('hidden');await refreshPrivateGaragesList();beginAutoRefresh();}async function refreshPrivateGaragesList(){try{const response = await nuiPost('getPrivateGarages',{});const text = await response.text();let garages = [];if (text){try{garages = JSON.parse(text);}catch (parseError){console.error('JSON parse error:',parseError);garages = [];}}privateGaragesCache = Array.isArray(garages) ? garages : [];renderPrivateGarages(privateGaragesCache);}catch (e){console.error('Error loading private garages:',e);privateGaragesCache = [];renderPrivateGarages([]);}}function renderPrivateGarages(garages){const container = document.getElementById('privateGaragesList');if (!container) return;const searchInput = document.getElementById('pgSearchInput');const searchTerm = (searchInput && searchInput.value ? searchInput.value : '').toLowerCase();const filtered = garages.filter(g =>{const name = (g.name || '').toLowerCase();const id = String(g.id || '');const type = String(g.type || '');return name.includes(searchTerm) || id.includes(searchTerm) || type.includes(searchTerm);});if (filtered.length === 0){const houseIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>';container.innerHTML = `
<div class="empty-state">
<div class="empty-state-icon">${houseIcon}</div>
<p>${LOCALE.noPrivateGarages}</p>
</div>
`;return;}container.innerHTML = filtered.map(g =>{const id = g.id || g.ID || g._id;const name = g.name || 'Private Garage';const type = g.type || 'car';const safeId = String(id).replace(/'/g,"\\'");const icon = getGarageIcon(type);const canEdit = g.canEdit === true || g.isOwner === true;return `
<div class="garage-card" data-id="${id}">
<div class="gc-head">
<span class="gc-icon">${icon}</span>
<span class="gc-badge">${type}</span>
<span class="gc-title">${name}</span>
<span class="gc-sub">ID: ${id}</span>
</div>
<div class="gc-actions">
${canEdit ? `<button class="btn btn-secondary" onclick="editGarage('${safeId}')">${LOCALE.edit}</button>` : ''}${canEdit ? `<button class="btn btn-danger" onclick="openDeleteModal('${safeId}')">${LOCALE.delete}</button>` : ''}</div>
</div>
`;}).join('');}function beginAutoRefresh(){if (autoRefreshTimer) return;autoRefreshTimer = setInterval(() =>{const privateGaragesMain = document.getElementById('privateGaragesMain');if (!privateGaragesMain || privateGaragesMain.classList.contains('hidden')){endAutoRefresh();return;}refreshPrivateGaragesList();},1500);}function endAutoRefresh(){if (autoRefreshTimer){clearInterval(autoRefreshTimer);autoRefreshTimer = null;}}function startAutoRefresh(){endAutoRefresh();autoRefreshTimer = setInterval(() =>{if (currentGarage){loadVehicles();}},30000);}function openCreateGarageModal(){showOnlyModal('createGarageModal');owners = [];renderOwners();document.getElementById('garageNameInput').value = '';document.getElementById('garageType').value = 'car';document.getElementById('locationX').value = '';document.getElementById('locationY').value = '';document.getElementById('locationZ').value = '';document.getElementById('locationHeading').value = '';document.getElementById('garageRadius').value = '10';}function closeCreateGarageModal(){hideAllModals();}async function getCurrentLocation(){try{const response = await nuiPost('getPlayerLocation',{});const text = await response.text();let location ={x: 0,y: 0,z: 0,heading: 0};if (text){try{location = JSON.parse(text);}catch (e){console.error('Error parsing location:',e);}}document.getElementById('locationX').value = Number(location.x || 0).toFixed(2);document.getElementById('locationY').value = Number(location.y || 0).toFixed(2);document.getElementById('locationZ').value = Number(location.z || 0).toFixed(2);document.getElementById('locationHeading').value = Number(location.heading || 0).toFixed(2);}catch (e){console.error('Error getting location:',e);alert('Error getting location. Make sure you are in game.');}}async function savePrivateGarage(){const name = document.getElementById('garageNameInput').value;const type = document.getElementById('garageType').value;const x = parseFloat(document.getElementById('locationX').value);const y = parseFloat(document.getElementById('locationY').value);const z = parseFloat(document.getElementById('locationZ').value);const heading = parseFloat(document.getElementById('locationHeading').value);const radius = parseInt(document.getElementById('garageRadius').value);if (!name || isNaN(x) || isNaN(y) || isNaN(z)){alert(LOCALE.pleaseFillAll);return;}const payload ={name: name,type: type,x: x,y: y,z: z,heading: heading || 0,radius: radius || 10,owners: owners};try{await nuiPost('createPrivateGarage',payload);hideAllModals();await refreshPrivateGaragesList();}catch (e){console.error('Error creating garage:',e);}}function editGarage(garageId){const garage = privateGaragesCache.find(g => 
String(g.id || g.ID || g._id) === String(garageId)
);if (!garage) return;showOnlyModal('editGarageModal');document.getElementById('editGarageId').value = garage.id || garage.ID || garage._id;document.getElementById('editGarageName').value = garage.name || '';document.getElementById('editGarageType').value = garage.type || 'car';document.getElementById('editGarageRadius').value = garage.radius || 10;}function closeEditGarageModal(){hideAllModals();}async function saveEditGarage(){const id = document.getElementById('editGarageId').value;const name = document.getElementById('editGarageName').value;const type = document.getElementById('editGarageType').value;const radius = parseInt(document.getElementById('editGarageRadius').value);if (!id || !name) return;try{await nuiPost('updatePrivateGarage',{id: id,name: name,type: type,radius: radius});const garage = privateGaragesCache.find(g => 
String(g.id || g.ID || g._id) === String(id)
);if (garage){garage.type = type;garage.name = name;garage.radius = radius;}if (currentGarage && String(currentGarage.id) === String(id)){currentGarage.type = type;currentGarage.name = name;currentGarage.radius = radius;const garageNameEl = document.getElementById('garageName');if (garageNameEl){garageNameEl.textContent = name;}const garageIconEl = document.getElementById('garageIcon');if (garageIconEl){garageIconEl.innerHTML = getGarageIcon(type);}}hideAllModals();await refreshPrivateGaragesList();}catch (e){console.error('Error updating garage:',e);}}function openDeleteModal(garageId){pendingDeleteGarageId = garageId;showOnlyModal('deleteModal');}function closeDeleteModal(){hideAllModals();pendingDeleteGarageId = null;}async function confirmDeleteGarage(){if (!pendingDeleteGarageId){closeDeleteModal();return;}const btn = document.getElementById('btnConfirmDelete');const originalText = btn.textContent;btn.disabled = true;btn.textContent = LOCALE.deleting;try{await nuiPost('deletePrivateGarage',{id: pendingDeleteGarageId});privateGaragesCache = privateGaragesCache.filter(g =>{const gid = g.id || g.ID || g._id;return String(gid) !== String(pendingDeleteGarageId);});renderPrivateGarages(privateGaragesCache);await refreshPrivateGaragesList();}catch (e){console.error('Error deleting garage:',e);}finally{btn.disabled = false;btn.textContent = originalText;closeDeleteModal();}}function renderOwners(){const container = document.getElementById('ownersList');if (owners.length === 0){container.innerHTML = '';return;}container.innerHTML = owners.map((owner,index) => `
<div class="owner-item">
<div class="owner-info">
<span class="owner-identifier">${owner.identifier}</span>
<span class="owner-name">${owner.name}</span>
</div>
<button class="btn btn-secondary" onclick="removeOwner(${index})">Remove</button>
</div>
`).join('');}function addOwner(){returnToModalId = getVisibleModalId();showOnlyModal('ownerModal');loadOnlinePlayersForOwner();}function removeOwner(index){owners.splice(index,1);renderOwners();}function clearOwners(){owners = [];renderOwners();}async function loadOnlinePlayersForOwner(){const select = document.getElementById('ownerSelect');select.innerHTML = `<option value="">${LOCALE.loadingPlayers}</option>`;try{const response = await nuiPost('getNearbyPlayers',{});const nearby = await response.json();let players = Array.isArray(nearby) ? nearby : [];if (!Array.isArray(players) || players.length === 0){select.innerHTML = `<option value="">${LOCALE.noPlayersOnline}</option>`;return;}select.innerHTML = players.map(p =>{const name = p.name || p.label || ('ID ' + (p.source || p.id || '?'));const license = p.license || (p.identifier && String(p.identifier).indexOf('license:') === 0 ? p.identifier : null);const citizenid = p.citizenid || p.identifier || p.id || p.source || '';const data = JSON.stringify({name: name,license: license,citizenid: citizenid});return `<option value='${data.replace(/'/g,"&apos;")}'>${name}${license ? (' (' + license + ')') : ''}</option>`;}).join('');}catch (e){console.error('Error loading players:',e);select.innerHTML = `<option value="">${LOCALE.errorFetching}</option>`;}}function getStatClass(value){if (typeof value !== 'number') return '';if (value >= 70) return 'stat-good';if (value >= 40) return 'stat-mid';return 'stat-low';}function getGarageIcon(type){const garageType = String(type || 'car').toLowerCase();const GARAGE_ICONS ={car: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 17h14v-5H5v5z"/><path d="M3 8l2-5h14l2 5"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M5 12h14"/></svg>',air: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>',boat: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 20a2.4 2.4 0 0 0 2 1 2.4 2.4 0 0 0 2-1 2.4 2.4 0 0 1 4 0 2.4 2.4 0 0 0 4 0 2.4 2.4 0 0 1 4 0 2.4 2.4 0 0 0 2 1 2.4 2.4 0 0 0 2-1"/><path d="M4 18 2 8l10-4 10 4-2 10"/><path d="M12 2v3"/><path d="M12 14v5"/></svg>'};return GARAGE_ICONS[garageType] || GARAGE_ICONS.car;}function getVehicleImageUrl(props){let modelName = String(props.modelName || props.model || '').toLowerCase().trim();if (!modelName){return getPlaceholderImage();}let cleanName = modelName.replace(/[^a-z0-9]/g,'');if (!cleanName || 
cleanName.length < 2 ||
/^\d+$/.test(cleanName) ||
/^vehicle\d{4,}$/.test(cleanName) ||
cleanName === 'unknown' || 
cleanName === 'vehicle'){return getPlaceholderImage();}return `images/${cleanName}.png`;}function getPlaceholderImage(){return 'images/custom.png';}function getPlaceholderImageEscaped(){return 'images/custom.png';}function getVehicleIcon(props){const vType = props._vehicleType || 'car';const modelName = String(props.modelName || props.model || '').toLowerCase();if (vType === 'air' || modelName.includes('heli') || modelName.includes('plane')){return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>`;}else if (vType === 'boat' || modelName.includes('boat') || modelName.includes('jet')){return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/></svg>`;}else if (modelName.includes('bike') || modelName.includes('cycl')){return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM5 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5zm5.8-10l2.4-2.4.8.8c1.3 1.3 3 2.1 5.1 2.1V9c-1.5 0-2.7-.6-3.6-1.5l-1.9-1.9c-.5-.4-1-.6-1.6-.6s-1.1.2-1.4.6L7.8 8.4c-.4.4-.6.9-.6 1.4 0 .6.2 1.1.6 1.4L11 14v5h2v-6.2l-2.2-2.3zM19 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5z"/></svg>`;}else{return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`;}}function toggleVehicleDetails(event,card){event.stopPropagation();document.querySelectorAll('.vehicle-card').forEach(c =>{if (c !== card){const details = c.querySelector('.vehicle-details');if (details) details.style.display = 'none';c.classList.remove('expanded');}});const details = card.querySelector('.vehicle-details');if (details){const isVisible = details.style.display !== 'none';details.style.display = isVisible ? 'none' : 'block';card.classList.toggle('expanded',!isVisible);}}function toggleImpoundDetails(card){if (!card) return;document.querySelectorAll('.impound-card').forEach(c =>{if (c !== card){const details = c.querySelector('.vehicle-details');if (details) details.style.display = 'none';c.classList.remove('expanded');}});const details = card.querySelector('.vehicle-details');if (details){const isVisible = details.style.display !== 'none';details.style.display = isVisible ? 'none' : 'block';card.classList.toggle('expanded',!isVisible);}}function selectAndSpawn(event,index){event.stopPropagation();const vehicle = currentVehicles[index];if (!vehicle) return;selectedVehicle = vehicle;if (vehicle.isDestroyed && vehicle.repairCost > 0){showRepairConfirmModal(vehicle);}else if (vehicle.isAbandoned || vehicle.existsInWorld){showRecoverConfirmModal(vehicle);}else{nuiPost('spawnVehicle',{plate: vehicle.plate});closeUI();}}function gpsToImpound(event,index){event.stopPropagation();const vehicle = currentVehicles[index];if (!vehicle || !vehicle.isImpounded) return;nuiPost('gpsToImpound',{plate: vehicle.plate,impoundId: vehicle.impoundId,impoundName: vehicle.impoundName,impoundFee: vehicle.impoundFee});closeUI();}const MODAL_ICONS ={repair: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',recover: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',repairOnly: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>'};function showRepairConfirmModal(vehicle){let modal = document.getElementById('repairConfirmModal');if (!modal){modal = document.createElement('div');modal.id = 'repairConfirmModal';modal.className = 'modal-overlay hidden';modal.innerHTML = `
<div class="modal-content">
<h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;vertical-align:middle;margin-right:8px;"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>${LOCALE.repairVehicle || 'Reparar VehÃ­culo'}</h2>
<p id="repairConfirmText"></p>
<div class="modal-actions">
<button id="cancelRepairBtn" class="btn btn-secondary">${LOCALE.cancel || 'Cancelar'}</button>
<button id="confirmRepairBtn" class="btn btn-danger">${LOCALE.confirm || 'Confirmar'}</button>
</div>
</div>
`;document.body.appendChild(modal);}const repairText = (LOCALE.repairConfirmText || 'Este vehÃ­culo estÃ¡ destruido. Â¿Deseas repararlo por ${cost}y usarlo?')
.replace('${cost}',`$${vehicle.repairCost || 0}`);const textEl = document.getElementById('repairConfirmText');if (textEl) textEl.textContent = repairText;modal.classList.remove('hidden');const confirmBtn = document.getElementById('confirmRepairBtn');const cancelBtn = document.getElementById('cancelRepairBtn');if (confirmBtn){confirmBtn.onclick = function(){modal.classList.add('hidden');closeUI();nuiPost('repairAndSpawnVehicle',{plate: vehicle.plate});};}if (cancelBtn){cancelBtn.onclick = function(){modal.classList.add('hidden');};}}function showRecoverConfirmModal(vehicle){let modal = document.getElementById('recoverConfirmModal');if (!modal){modal = document.createElement('div');modal.id = 'recoverConfirmModal';modal.className = 'modal-overlay hidden';modal.innerHTML = `
<div class="modal-content">
<h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;vertical-align:middle;margin-right:8px;"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>${LOCALE.recoverVehicle || 'Recuperar VehÃ­culo'}</h2>
<p id="recoverConfirmText"></p>
<div class="modal-actions">
<button id="cancelRecoverBtn" class="btn btn-secondary">${LOCALE.cancel || 'Cancelar'}</button>
<button id="confirmRecoverBtn" class="btn btn-warning">${LOCALE.confirm || 'Confirmar'}</button>
</div>
</div>
`;document.body.appendChild(modal);}const cost = vehicle.recoverCost || vehicle.repairCost || 0;const costText = cost > 0 ? `$${cost}` : (LOCALE.free || 'gratis');const recoverText = (LOCALE.recoverToGarageText || 'Tu vehÃ­culo estÃ¡ abandonado en el mapa. Â¿Deseas recuperarlo por ${cost}y guardarlo en este garaje? El vehÃ­culo serÃ¡ reparado y el original eliminado.')
.replace('${cost}',costText);const textEl = document.getElementById('recoverConfirmText');if (textEl) textEl.textContent = recoverText;modal.classList.remove('hidden');const confirmBtn = document.getElementById('confirmRecoverBtn');const cancelBtn = document.getElementById('cancelRecoverBtn');if (confirmBtn){confirmBtn.onclick = async function(){modal.classList.add('hidden');showVehiclesLoading();try{await nuiPost('recoverAndSpawnVehicle',{plate: vehicle.plate});await new Promise(resolve => setTimeout(resolve,800));await refreshVehiclesList();}catch(e){console.error('Error recovering vehicle:',e);await refreshVehiclesList();}};}if (cancelBtn){cancelBtn.onclick = function(){modal.classList.add('hidden');};}}function repairOnly(event,index){event.stopPropagation();const vehicle = currentVehicles[index];if (!vehicle) return;selectedVehicle = vehicle;showRepairOnlyModal(vehicle);}function showRepairOnlyModal(vehicle){let modal = document.getElementById('repairOnlyModal');if (!modal){modal = document.createElement('div');modal.id = 'repairOnlyModal';modal.className = 'modal-overlay';modal.innerHTML = `
<div class="modal-content">
<h2>${MODAL_ICONS.repair}${LOCALE.repairVehicle || 'Reparar VehÃ­culo'}</h2>
<p id="repairOnlyText"></p>
<div class="modal-actions">
<button id="cancelRepairOnlyBtn" class="btn btn-secondary">${LOCALE.cancel || 'Cancelar'}</button>
<button id="confirmRepairOnlyBtn" class="btn btn-repair">${LOCALE.confirm || 'Confirmar'}</button>
</div>
</div>
`;document.body.appendChild(modal);}const cost = vehicle.repairCost || 0;let statusText = '';if (vehicle.isDestroyed){statusText = LOCALE.vehicleDestroyed || 'Tu vehÃ­culo estÃ¡ destruido.';}else if (vehicle.existsInWorld){statusText = LOCALE.vehicleAbandoned || 'Tu vehÃ­culo estÃ¡ abandonado en el mundo.';}else{const enginePct = Math.round((vehicle.engine || 1000) / 10);const bodyPct = Math.round((vehicle.body || 1000) / 10);statusText = (LOCALE.vehicleHasDamage || 'Tu vehÃ­culo tiene daÃ±os (Motor: ${engine}%,CarrocerÃ­a: ${body}%).')
.replace('${engine}',enginePct)
.replace('${body}',bodyPct);}const repairFullText = (LOCALE.repairOnlyConfirmText || '${status}Â¿Deseas repararlo por ${cost}? El vehÃ­culo quedarÃ¡ completamente reparado.')
.replace('${status}',statusText)
.replace('${cost}',`$${cost}`);document.getElementById('repairOnlyText').textContent = repairFullText;modal.classList.remove('hidden');const plateToRepair = vehicle.plate;document.getElementById('confirmRepairOnlyBtn').onclick = async function(){modal.classList.add('hidden');await nuiPost('repairOnlyVehicle',{plate: plateToRepair});await new Promise(resolve => setTimeout(resolve,500));await refreshVehiclesList();};document.getElementById('cancelRepairOnlyBtn').onclick = function(){modal.classList.add('hidden');};}async function refreshVehiclesList(){if (!currentGarage) return;try{const response = await nuiPost('getVehicles',{garageId: currentGarage.id});const vehicles = await response.json();currentVehicles = vehicles || [];renderVehicles(currentVehicles,{garageId: currentGarage.id,garageType: currentGarage.type || 'car'});}catch (e){console.error('Error refreshing vehicles:',e);}}function selectAndTransfer(event,index){event.stopPropagation();const vehicle = currentVehicles[index];if (!vehicle) return;selectedVehicle = vehicle;updateTransferTargets(DOM.transferType?.value || 'garage');showOnlyModal('transferModal');}async function bringVehicleHere(event,index){event.stopPropagation();const vehicle = currentVehicles[index];if (!vehicle || !currentGarage) return;try{await nuiPost('bringVehicleHere',{plate: vehicle.plate,targetGarageId: currentGarage.id});await new Promise(resolve => setTimeout(resolve,1000));await refreshVehiclesList();}catch (e){console.error('Error bringing vehicle here:',e);}}function updateVehicleCount(){const el = document.getElementById('vehicleCount');if (!el) return;const count = Array.isArray(currentVehicles) ? currentVehicles.length : 0;el.textContent = `${count}vehicle(s)`;}function openTransferModal(){showOnlyModal('transferModal');const type = document.getElementById('transferType');const targetSelect = document.getElementById('targetSelect');const targetLabel = document.getElementById('targetLabel');if (!type || !targetSelect) return;const updateTargets = async () =>{const t = type.value;targetSelect.innerHTML = `<option value="">${LOCALE.loading}</option>`;if (t === 'player'){try{const res = await nuiPost('getNearbyPlayers',{});const list = await res.json().catch(() => []);const players = Array.isArray(list) ? list : [];if (players.length === 0){targetSelect.innerHTML = `<option value="">${LOCALE.noPlayersNearby}</option>`;return;}targetSelect.innerHTML = players.map(p =>{const name = p.name || p.label || ('ID ' + (p.source || p.id || '?'));const raw = p.license || p.identifier || p.id || p.source || '';return `<option value='${String(raw).replace(/'/g,"&apos;")}'>${name}</option>`;}).join('');targetLabel.textContent = 'Select Player';}catch (e){console.error('Error loading players for transfer:',e);targetSelect.innerHTML = `<option value="">${LOCALE.errorFetching}</option>`;}}else{const list = Array.isArray(privateGaragesCache) ? privateGaragesCache : [];if (list.length === 0){targetSelect.innerHTML = `<option value="">${LOCALE.noGaragesAvailable}</option>`;return;}targetSelect.innerHTML = list.map(g =>{const id = g.id || g.ID || g._id;const name = g.name || ('Garage ' + id);return `<option value='${String(id).replace(/'/g,"&apos;")}'>${name}</option>`;}).join('');targetLabel.textContent = 'Select Garage';}};updateTargets();type.addEventListener('change',updateTargets);}function closeTransferModal(){hideAllModals();const targetSelect = document.getElementById('targetSelect');if (targetSelect) targetSelect.innerHTML = `<option value="">${LOCALE.loading}</option>`;}function closeOwnerModal(){hideAllModals();if (returnToModalId){showOnlyModal(returnToModalId);returnToModalId = null;}}function confirmAddOwner(){const select = document.getElementById('ownerSelect');if (!select || !select.value){closeOwnerModal();return;}try{const data = JSON.parse(select.value);const raw = data.license || data.citizenid || data.name;const identifier = raw ? (String(raw).indexOf('char1:') === 0 ? raw : ('char1:' + raw)) : 'char1:unknown';owners.push({identifier: identifier,name: data.name || identifier});renderOwners();closeOwnerModal();}catch (e){console.error('Error adding owner:',e);closeOwnerModal();}}function closeUI(){document.getElementById('app').classList.add('hidden');document.getElementById('garageMain').classList.add('hidden');document.getElementById('privateGaragesMain').classList.add('hidden');document.getElementById('impoundMain')?.classList.add('hidden');document.getElementById('impoundFormModal')?.classList.add('hidden');hideAllModals();selectedVehicle = null;currentGarage = null;currentVehicles = [];currentImpound = null;impoundVehicles = [];impoundFormData = null;cachedGaragesForTransfer = null;cacheTimestamp = 0;document.querySelectorAll('.vehicle-card.expanded').forEach(card =>{card.classList.remove('expanded');const details = card.querySelector('.vehicle-details');if (details) details.style.display = 'none';});endAutoRefresh();nuiPost('closeUI',{});}document.addEventListener('keydown',(e) =>{if (e.key === 'Escape'){e.preventDefault();closeUI();}});function injectDefaultStyles(){if (document.getElementById('kr-garages-default-styles')) return;const css = `
.vehicle-card.selected{border: 2px solid #3b82f6;box-shadow: 0 2px 8px rgba(0,0,0,0.15);}.stat-bar-fill.stat-good{background: linear-gradient(90deg,#10b981,#34d399);}.stat-bar-fill.stat-mid{background: linear-gradient(90deg,#f59e0b,#fbbf24);}.stat-bar-fill.stat-low{background: linear-gradient(90deg,#ef4444,#f97316);}`;const el = document.createElement('style');el.id = 'kr-garages-default-styles';el.textContent = css;document.head.appendChild(el);}async function fetchNearbyPlayers(){try{const res = await nuiPost('getNearbyPlayers',{});const list = await res.json().catch(() => []);return Array.isArray(list) ? list : [];}catch (e){console.error('fetchNearbyPlayers error:',e);return [];}}async function fetchPrivateGarages(){await refreshPrivateGaragesList().catch(() =>{});return Array.isArray(privateGaragesCache) ? privateGaragesCache : [];}async function fetchPublicGarages(){try{const res = await nuiPost('getPublicGarages',{});const list = await res.json().catch(() => []);return Array.isArray(list) ? list : [];}catch (e){console.error('fetchPublicGarages error:',e);return [];}}async function fetchAllGaragesForTransfer(){try{const timeoutPromise = new Promise((_,reject) => 
setTimeout(() => reject(new Error('Timeout')),5000)
);const fetchPromise = nuiPost('getAllGaragesForTransfer',{}).then(res => res.json());const list = await Promise.race([fetchPromise,timeoutPromise]).catch(() => []);return Array.isArray(list) ? list : [];}catch (e){console.error('fetchAllGaragesForTransfer error:',e);return [];}}async function updateTransferTargets(type){const t = (type || DOM.transferType?.value || 'garage');if (!DOM.targetSelect) return;DOM.targetSelect.innerHTML = `<option value="">${LOCALE.loading}</option>`;if (t === 'player'){const players = await fetchNearbyPlayers();if (!players || players.length === 0){DOM.targetSelect.innerHTML = `<option value="">${LOCALE.noPlayersNearby}</option>`;return;}DOM.targetSelect.innerHTML = players.map(p =>{const name = p.name || p.label || ('ID ' + (p.source || p.id || '?'));const raw = p.license || p.identifier || p.id || p.source || '';return `<option value='${String(raw).replace(/'/g,"&apos;")}'>${name}</option>`;}).join('');if (DOM.targetLabel) DOM.targetLabel.textContent = LOCALE.selectPlayer;}else{const garages = await fetchAllGaragesForTransfer();if (!garages || garages.length === 0){DOM.targetSelect.innerHTML = `<option value="">${LOCALE.noGaragesAvailable}</option>`;if (DOM.targetLabel) DOM.targetLabel.textContent = LOCALE.selectGarage;return;}let vehicleType = null;if (selectedVehicle && selectedVehicle.props && selectedVehicle.props._vehicleType){vehicleType = selectedVehicle.props._vehicleType;}else if (currentGarage && currentGarage.type){vehicleType = currentGarage.type;}else if (currentGarage && currentGarage.vehicleType){vehicleType = currentGarage.vehicleType;}let filteredGarages = garages;if (vehicleType){filteredGarages = garages.filter(g =>{return g.type === vehicleType;});}if (selectedVehicle && selectedVehicle.garageId){const vehicleGarageId = String(selectedVehicle.garageId);filteredGarages = filteredGarages.filter(g =>{const gId = String(g.id || g.ID || g._id || '');return gId !== vehicleGarageId && 
gId !== vehicleGarageId.replace('private_','') &&
('private_' + gId) !== vehicleGarageId;});}if (currentGarage && currentGarage.id && selectedVehicle){const currentId = String(currentGarage.id);const vehicleGarageId = selectedVehicle.garageId ? String(selectedVehicle.garageId) : '';const vehicleIsInCurrentGarage = vehicleGarageId === currentId || 
vehicleGarageId === ('private_' + currentId) ||
vehicleGarageId.replace('private_','') === currentId;if (vehicleIsInCurrentGarage){filteredGarages = filteredGarages.filter(g =>{const gId = String(g.id || g.ID || g._id || '');return gId !== currentId;});}}if (filteredGarages.length === 0){const vType = selectedVehicle?.props?._vehicleType || 'este tipo';DOM.targetSelect.innerHTML = `<option value="">No hay otros garajes disponibles</option>`;if (DOM.targetLabel) DOM.targetLabel.textContent = LOCALE.selectGarage;return;}DOM.targetSelect.innerHTML = filteredGarages.map(g =>{const id = g.id || g.ID || g._id;const name = g.name || ('Garage ' + id);const typeLabel = g.garageType === 'private' ? '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"width:14px;height:14px;vertical-align:middle;margin-right:4px;\"><rect width=\"18\" height=\"11\" x=\"3\" y=\"11\" rx=\"2\" ry=\"2\"/><path d=\"M7 11V7a5 5 0 0 1 10 0v4\"/></svg>' : '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"width:14px;height:14px;vertical-align:middle;margin-right:4px;\"><rect width=\"16\" height=\"20\" x=\"4\" y=\"2\" rx=\"2\" ry=\"2\"/><path d=\"M9 22v-4h6v4\"/><path d=\"M8 6h.01\"/><path d=\"M16 6h.01\"/><path d=\"M12 6h.01\"/><path d=\"M12 10h.01\"/><path d=\"M12 14h.01\"/><path d=\"M16 10h.01\"/><path d=\"M16 14h.01\"/><path d=\"M8 10h.01\"/><path d=\"M8 14h.01\"/></svg>';return `<option value='${String(id).replace(/'/g,"&apos;")}'>${typeLabel}${name}</option>`;}).join('');if (DOM.targetLabel) DOM.targetLabel.textContent = LOCALE.selectGarage;}}function initUI(){DOM.confirmTransferBtn = document.getElementById('confirmTransferBtn');DOM.transferType = document.getElementById('transferType');DOM.targetSelect = document.getElementById('targetSelect');DOM.targetLabel = document.getElementById('targetLabel');DOM.vehiclesList = document.getElementById('vehiclesList') || document.getElementById('vehicles-list');DOM.privateGaragesList = document.getElementById('privateGaragesList');DOM.pgSearchInput = document.getElementById('pgSearchInput');DOM.ownerSelect = document.getElementById('ownerSelect');if (DOM.transferType){DOM.transferType.addEventListener('change',() => updateTransferTargets(DOM.transferType.value));}if (DOM.confirmTransferBtn){DOM.confirmTransferBtn.addEventListener('click',async () =>{const type = DOM.transferType?.value || 'garage';const target = DOM.targetSelect?.value;if (!target || !selectedVehicle) return;DOM.confirmTransferBtn.disabled = true;const originalText = DOM.confirmTransferBtn.textContent;DOM.confirmTransferBtn.textContent = 'Transfiriendo...';await nuiPost('transferVehicle',{plate: selectedVehicle.plate,target: target,transferType: type});await new Promise(resolve => setTimeout(resolve,1200));await refreshVehiclesList();hideAllModals();DOM.confirmTransferBtn.disabled = false;DOM.confirmTransferBtn.textContent = originalText;});}}initUI();function debounce(fn,ms = 200){let t = null;return (...args) =>{clearTimeout(t);t = setTimeout(() => fn.apply(this,args),ms);};}const applyVehicleSearch = debounce(() =>{const term = (DOM.searchInput?.value || '').toLowerCase().trim();if (!term){renderVehicles(currentVehicles);return;}const filtered = (currentVehicles || []).filter(v =>{const props = v.props ||{};const modelName = String(props.modelName || props.modelLabel || props.model || v.vehicle || '').toLowerCase();const plate = String(v.plate || '').toLowerCase();return modelName.includes(term) || plate.includes(term);});renderVehicles(filtered);},180);if (!DOM.searchInput) DOM.searchInput = document.getElementById('searchInput');if (DOM.searchInput) DOM.searchInput.addEventListener('input',applyVehicleSearch);if (DOM.pgSearchInput){const debouncedPG = debounce(() => renderPrivateGarages(privateGaragesCache),200);DOM.pgSearchInput.addEventListener('input',debouncedPG);}window.closeUI = closeUI;window.closeTransferModal = closeTransferModal;window.openCreateGarageModal = openCreateGarageModal;window.closeCreateGarageModal = closeCreateGarageModal;window.getCurrentLocation = getCurrentLocation;window.savePrivateGarage = savePrivateGarage;window.editGarage = editGarage;window.closeEditGarageModal = closeEditGarageModal;window.saveEditGarage = saveEditGarage;window.openDeleteModal = openDeleteModal;window.closeDeleteModal = closeDeleteModal;window.confirmDeleteGarage = confirmDeleteGarage;window.addOwner = addOwner;window.removeOwner = removeOwner;window.clearOwners = clearOwners;window.closeOwnerModal = closeOwnerModal;window.confirmAddOwner = confirmAddOwner;window.loadVehicles = loadVehicles;window.toggleVehicleDetails = toggleVehicleDetails;window.selectAndSpawn = selectAndSpawn;window.selectAndTransfer = selectAndTransfer;window.closeOwnerModal = closeOwnerModal;window.confirmAddOwner = confirmAddOwner;window.openAccessModal = openAccessModal;window.openAccessModalFromGarage = openAccessModalFromGarage;window.closeAccessModal = closeAccessModal;window.addMemberToGarage = addMemberToGarage;window.removeMemberFromGarage = removeMemberFromGarage;window.removeMemberByIndex = removeMemberByIndex;window.addMemberByIndex = addMemberByIndex;let currentAccessGarageId = null;let onlinePlayers = [];let garageMembers = [];async function openAccessModal(garageId){currentAccessGarageId = garageId;showOnlyModal('accessModal');document.getElementById('accessGarageId').value = garageId;await loadGarageMembers(garageId);await loadOnlinePlayers();}async function openAccessModalFromGarage(){if (!currentGarage || !currentGarage.id){console.error('No hay garaje actual o no tiene ID');alert('Error: No se pudo identificar el garaje actual');return;}if (currentGarage.garageType !== 'private'){console.error('No es un garaje privado');alert('Solo los garajes privados pueden compartir acceso');return;}const canEdit = currentGarage.canEdit === true || currentGarage.isOwner === true;if (!canEdit){console.error('No tienes permisos para gestionar este garaje');alert('Solo el dueÃ±o o un administrador pueden compartir acceso');return;}await openAccessModal(currentGarage.id);}function closeAccessModal(){hideAllModals();currentAccessGarageId = null;onlinePlayers = [];garageMembers = [];}async function loadGarageMembers(garageId){try{const response = await nuiPost('getGarageMembers',{garageId: garageId});const result = await response.json();if (result.ok && Array.isArray(result.members)){garageMembers = result.members;renderGarageMembers(result.members);}else{if (result.reason){console.warn('Error al cargar miembros:',result.reason);closeAccessModal();alert(result.reason);}else{garageMembers = [];renderGarageMembers([]);}}}catch (e){console.error('Error loading garage members:',e);garageMembers = [];renderGarageMembers([]);}}function renderGarageMembers(members){const container = document.getElementById('membersList');const countEl = document.getElementById('memberCount');if (countEl){countEl.textContent = members.length;}if (!container) return;if (members.length === 0){container.innerHTML = `
<div class="empty-state-small">
<p>No hay usuarios con acceso compartido</p>
</div>
`;return;}window._garageMembers = members;container.innerHTML = members.map((member,index) =>{const name = member.firstname && member.lastname 
? `${member.firstname}${member.lastname}` 
: 'Usuario';const addedDate = member.added_at ? new Date(member.added_at).toLocaleDateString() : 'Desconocido';return `
<div class="member-item">
<div class="member-info">
<span class="member-name"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-right:4px;vertical-align:middle;"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${name}</span>
<span class="member-date">Agregado: ${addedDate}</span>
</div>
<button class="btn btn-danger btn-small" onclick="removeMemberByIndex(${index})">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;margin-right:4px;vertical-align:middle;"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>Remover
</button>
</div>
`;}).join('');}async function removeMemberByIndex(index){if (!window._garageMembers || !window._garageMembers[index]){console.error('Miembro no encontrado');return;}const member = window._garageMembers[index];await removeMemberFromGarage(member.identifier);}async function loadOnlinePlayers(){try{const response = await nuiPost('getOnlinePlayers',{});const players = await response.json();onlinePlayers = Array.isArray(players) ? players : [];renderOnlinePlayers(onlinePlayers);}catch (e){console.error('Error loading online players:',e);onlinePlayers = [];renderOnlinePlayers([]);}}function renderOnlinePlayers(players){const container = document.getElementById('onlinePlayersList');if (!container) return;const memberIdentifiers = garageMembers.map(m => m.identifier);const availablePlayers = players.filter(p => !memberIdentifiers.includes(p.identifier));const searchInput = document.getElementById('memberSearchInput');const searchTerm = (searchInput && searchInput.value ? searchInput.value : '').toLowerCase();const filtered = availablePlayers.filter(p =>{const name = String(p.name || '').toLowerCase();return name.includes(searchTerm);});window._filteredPlayers = filtered;if (filtered.length === 0){container.innerHTML = `
<div class="empty-state-small">
<p>${searchTerm ? 'No se encontraron jugadores' : 'No hay jugadores disponibles'}</p>
</div>
`;return;}container.innerHTML = filtered.map((player,index) =>{const safeName = String(player.name || 'Desconocido').replace(/</g,'&lt;').replace(/>/g,'&gt;');return `
<div class="player-item">
<div class="player-info">
<span class="player-name"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-right:4px;vertical-align:middle;"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${safeName}</span>
</div>
<button class="btn btn-primary btn-small" onclick="addMemberByIndex(${index})">
+ Agregar
</button>
</div>
`;}).join('');}async function addMemberByIndex(index){if (!window._filteredPlayers || !window._filteredPlayers[index]){console.error('Jugador no encontrado');return;}const player = window._filteredPlayers[index];await addMemberToGarage(player.identifier);}async function addMemberToGarage(identifier){if (!currentAccessGarageId){console.error('No hay garaje actual');return;}if (!identifier || identifier === ''){console.error('Identifier vacÃ­o');return;}if (garageMembers.length >= 5){showConfirmModal('LÃ­mite alcanzado','Has alcanzado el lÃ­mite mÃ¡ximo de 5 usuarios compartidos','Entendido',() =>{});return;}try{const response = await nuiPost('addGarageMember',{garageId: currentAccessGarageId,identifier: identifier});const result = await response.json();if (result.ok){await loadGarageMembers(currentAccessGarageId);await loadOnlinePlayers();}else{console.warn('Error al agregar miembro:',result.reason);}}catch (e){console.error('Error adding member:',e);}}async function removeMemberFromGarage(identifier){if (!currentAccessGarageId){console.error('No hay garaje actual');return;}if (!identifier || identifier === ''){console.error('Identifier vacÃ­o');return;}window._pendingRemoveIdentifier = identifier;showConfirmModal(
'Remover Acceso','Â¿EstÃ¡s seguro de que quieres remover el acceso a este usuario?','Remover',async () =>{const identifierToRemove = window._pendingRemoveIdentifier;window._pendingRemoveIdentifier = null;try{const response = await nuiPost('removeGarageMember',{garageId: currentAccessGarageId,identifier: identifierToRemove});const result = await response.json();if (result.ok){await loadGarageMembers(currentAccessGarageId);await loadOnlinePlayers();}else{console.warn('Error al remover miembro:',result.reason);}}catch (e){console.error('Error removing member:',e);}});}let confirmModalCallback = null;function showConfirmModal(title,message,buttonText,callback){const modal = document.getElementById('confirmModal');const titleEl = document.getElementById('confirmModalTitle');const messageEl = document.getElementById('confirmModalMessage');const btnEl = document.getElementById('confirmModalBtn');if (titleEl) titleEl.textContent = title;if (messageEl) messageEl.textContent = message;if (btnEl) btnEl.textContent = buttonText || 'Confirmar';confirmModalCallback = callback;if (modal) modal.classList.remove('hidden');}function closeConfirmModal(){const modal = document.getElementById('confirmModal');if (modal) modal.classList.add('hidden');confirmModalCallback = null;window._pendingRemoveIdentifier = null;}function executeConfirmAction(){if (confirmModalCallback && typeof confirmModalCallback === 'function'){confirmModalCallback();}closeConfirmModal();}window.showConfirmModal = showConfirmModal;window.closeConfirmModal = closeConfirmModal;window.executeConfirmAction = executeConfirmAction;const memberSearchInput = document.getElementById('memberSearchInput');if (memberSearchInput){memberSearchInput.addEventListener('input',debounce(() =>{renderOnlinePlayers(onlinePlayers);},200));}window.loadVehicles = loadVehicles;let publicGarages = [];let editingPublicGarageId = null;let spawnPoints = [];function openPublicGaragesAdmin(garages){publicGarages = garages || [];document.getElementById('app').classList.remove('hidden');document.getElementById('garageMain').classList.add('hidden');document.getElementById('privateGaragesMain').classList.add('hidden');document.getElementById('publicGaragesAdmin').classList.remove('hidden');renderPublicGarages();updatePublicGarageCount();const searchInput = document.getElementById('publicGarageSearchInput');if (searchInput){searchInput.addEventListener('input',debounce(() =>{filterPublicGarages(searchInput.value);},200));}}function closePublicGaragesAdmin(){document.getElementById('publicGaragesAdmin').classList.add('hidden');document.getElementById('app').classList.add('hidden');nuiPost('closeUI',{});}function renderPublicGarages(){const container = document.getElementById('publicGaragesList');if (!container) return;if (publicGarages.length === 0){container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg></div><p>No hay garajes pÃºblicos configurados</p></div>`;return;}container.innerHTML = publicGarages.map((g,idx) =>{const typeIcon = getGarageIcon(g.type);const typeLabel = g.type === 'air' ? 'AÃ©reo' : (g.type === 'boat' ? 'NÃ¡utico' : 'Terrestre');return `
<div class="garage-card" data-idx="${idx}">
<div class="garage-card-header">
<div class="garage-card-icon" style="background: linear-gradient(135deg,#06b6d4,#0891b2);">
${typeIcon}</div>
<div class="garage-card-info">
<h3 class="garage-card-name">${escapeHtml(g.name)}</h3>
<span class="garage-card-id">ID: ${escapeHtml(g.id)}</span>
</div>
</div>
<div class="garage-card-details">
<div class="garage-card-detail">
<span class="detail-label">Tipo</span>
<span class="detail-value">${typeLabel}</span>
</div>
<div class="garage-card-detail">
<span class="detail-label">Radio</span>
<span class="detail-value">${g.radius || 10}m</span>
</div>
<div class="garage-card-detail">
<span class="detail-label">Spawns</span>
<span class="detail-value">${(g.spawnPoints || []).length}</span>
</div>
</div>
<div class="garage-card-coords" style="font-size: 0.75rem;color: var(--text-muted);margin-top: 8px;">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;margin-right:4px;vertical-align:middle;"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
${g.coords?.x?.toFixed(1) || 0},${g.coords?.y?.toFixed(1) || 0},${g.coords?.z?.toFixed(1) || 0}</div>
<div class="garage-card-actions">
<button class="btn btn-secondary btn-small" onclick="teleportToPublicGarage(${idx})">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
TP
</button>
<button class="btn btn-primary btn-small" onclick="editPublicGarage(${idx})" style="background: linear-gradient(135deg,#3b82f6,#2563eb);">
Editar
</button>
<button class="btn btn-danger btn-small" onclick="deletePublicGarage(${idx})">
Eliminar
</button>
</div>
</div>
`;}).join('');}function filterPublicGarages(query){if (!query || query.trim() === ''){renderPublicGarages();return;}const q = query.toLowerCase();const filtered = publicGarages.filter(g => 
g.name.toLowerCase().includes(q) || g.id.toLowerCase().includes(q)
);const container = document.getElementById('publicGaragesList');if (!container) return;if (filtered.length === 0){container.innerHTML = `<div class="empty-state"><p>No se encontraron garajes</p></div>`;return;}container.innerHTML = filtered.map((g) =>{const idx = publicGarages.indexOf(g);const typeIcon = getGarageIcon(g.type);const typeLabel = g.type === 'air' ? 'AÃ©reo' : (g.type === 'boat' ? 'NÃ¡utico' : 'Terrestre');return `
<div class="garage-card" data-idx="${idx}">
<div class="garage-card-header">
<div class="garage-card-icon" style="background: linear-gradient(135deg,#06b6d4,#0891b2);">
${typeIcon}</div>
<div class="garage-card-info">
<h3 class="garage-card-name">${escapeHtml(g.name)}</h3>
<span class="garage-card-id">ID: ${escapeHtml(g.id)}</span>
</div>
</div>
<div class="garage-card-details">
<div class="garage-card-detail">
<span class="detail-label">Tipo</span>
<span class="detail-value">${typeLabel}</span>
</div>
<div class="garage-card-detail">
<span class="detail-label">Radio</span>
<span class="detail-value">${g.radius || 10}m</span>
</div>
<div class="garage-card-detail">
<span class="detail-label">Spawns</span>
<span class="detail-value">${(g.spawnPoints || []).length}</span>
</div>
</div>
<div class="garage-card-coords" style="font-size: 0.75rem;color: var(--text-muted);margin-top: 8px;">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;margin-right:4px;vertical-align:middle;"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
${g.coords?.x?.toFixed(1) || 0},${g.coords?.y?.toFixed(1) || 0},${g.coords?.z?.toFixed(1) || 0}</div>
<div class="garage-card-actions">
<button class="btn btn-secondary btn-small" onclick="teleportToPublicGarage(${idx})">TP</button>
<button class="btn btn-primary btn-small" onclick="editPublicGarage(${idx})" style="background: linear-gradient(135deg,#3b82f6,#2563eb);">Editar</button>
<button class="btn btn-danger btn-small" onclick="deletePublicGarage(${idx})">Eliminar</button>
</div>
</div>
`;}).join('');}function updatePublicGarageCount(){const countEl = document.getElementById('publicGarageCount');if (countEl){countEl.textContent = `${publicGarages.length}garaje(s) pÃºblicos`;}}function openCreatePublicGarageModal(){editingPublicGarageId = null;spawnPoints = [];document.getElementById('publicGarageId').value = '';document.getElementById('publicGarageName').value = '';document.getElementById('publicGarageType').value = 'car';document.getElementById('publicGarageRadius').value = '15';document.getElementById('publicGarageX').value = '';document.getElementById('publicGarageY').value = '';document.getElementById('publicGarageZ').value = '';document.getElementById('publicGarageBlipSprite').value = '357';document.getElementById('publicGarageBlipColor').value = '47';document.getElementById('publicGarageBlipScale').value = '0.6';renderSpawnPoints();const modalTitle = document.querySelector('#createPublicGarageModal .modal-title');if (modalTitle) modalTitle.textContent = 'Crear Garaje PÃºblico';const saveBtn = document.querySelector('#createPublicGarageModal .modal-footer .btn-primary');if (saveBtn) saveBtn.textContent = 'Crear Garaje';document.getElementById('createPublicGarageModal').classList.remove('hidden');}function closeCreatePublicGarageModal(){document.getElementById('createPublicGarageModal').classList.add('hidden');spawnPoints = [];editingPublicGarageId = null;}function editPublicGarage(idx){const garage = publicGarages[idx];if (!garage) return;editingPublicGarageId = garage.id;spawnPoints = (garage.spawnPoints || []).map(sp => ({x: sp.x || sp[1] || 0,y: sp.y || sp[2] || 0,z: sp.z || sp[3] || 0,heading: sp.heading || sp.w || sp[4] || 0}));document.getElementById('publicGarageId').value = garage.id;document.getElementById('publicGarageName').value = garage.name;document.getElementById('publicGarageType').value = garage.type || 'car';document.getElementById('publicGarageRadius').value = garage.radius || 15;document.getElementById('publicGarageX').value = garage.coords?.x || '';document.getElementById('publicGarageY').value = garage.coords?.y || '';document.getElementById('publicGarageZ').value = garage.coords?.z || '';document.getElementById('publicGarageBlipSprite').value = garage.blip?.sprite || 357;document.getElementById('publicGarageBlipColor').value = garage.blip?.color || 47;document.getElementById('publicGarageBlipScale').value = garage.blip?.scale || 0.6;renderSpawnPoints();const modalTitle = document.querySelector('#createPublicGarageModal .modal-title');if (modalTitle) modalTitle.textContent = 'Editar Garaje PÃºblico';const saveBtn = document.querySelector('#createPublicGarageModal .modal-footer .btn-primary');if (saveBtn) saveBtn.textContent = 'Guardar';document.getElementById('createPublicGarageModal').classList.remove('hidden');}function deletePublicGarage(idx){const garage = publicGarages[idx];if (!garage) return;showConfirmModal(
'Eliminar Garaje',`Â¿EstÃ¡s seguro de que quieres eliminar el garaje "${garage.name}"?`,'Eliminar',() =>{publicGarages.splice(idx,1);renderPublicGarages();updatePublicGarageCount();nuiPost('deletePublicGarage',{garageId: garage.id});});}function teleportToPublicGarage(idx){const garage = publicGarages[idx];if (!garage || !garage.coords) return;nuiPost('teleportToCoords',{x: garage.coords.x,y: garage.coords.y,z: garage.coords.z});}function addSpawnPoint(){spawnPoints.push({x: 0,y: 0,z: 0,heading: 0});renderSpawnPoints();}function addCurrentPositionAsSpawn(){nuiPost('getCurrentPosition',{}).then(res => res.json()).then(pos =>{if (pos && pos.x !== undefined){spawnPoints.push({x: parseFloat(pos.x.toFixed(2)),y: parseFloat(pos.y.toFixed(2)),z: parseFloat(pos.z.toFixed(2)),heading: parseFloat((pos.heading || 0).toFixed(2))});renderSpawnPoints();}}).catch(e =>{addSpawnPoint();});}function removeSpawnPoint(idx){spawnPoints.splice(idx,1);renderSpawnPoints();}function renderSpawnPoints(){const container = document.getElementById('spawnPointsList');if (!container) return;if (spawnPoints.length === 0){container.innerHTML = '<p style="color: var(--text-muted);font-style: italic;">No hay puntos de spawn definidos</p>';return;}container.innerHTML = spawnPoints.map((sp,idx) => `
<div class="spawn-point-item" style="display: flex;gap: 8px;align-items: center;margin-bottom: 8px;padding: 10px;background: rgba(0,0,0,0.2);border-radius: 8px;">
<span style="color: var(--accent);font-weight: 600;min-width: 20px;">#${idx + 1}</span>
<div style="display: flex;gap: 6px;flex: 1;">
<input type="number" class="form-input" value="${sp.x}" onchange="updateSpawnPoint(${idx},'x',this.value)" style="width: 70px;padding: 6px;" placeholder="X" step="0.01">
<input type="number" class="form-input" value="${sp.y}" onchange="updateSpawnPoint(${idx},'y',this.value)" style="width: 70px;padding: 6px;" placeholder="Y" step="0.01">
<input type="number" class="form-input" value="${sp.z}" onchange="updateSpawnPoint(${idx},'z',this.value)" style="width: 70px;padding: 6px;" placeholder="Z" step="0.01">
<input type="number" class="form-input" value="${sp.heading}" onchange="updateSpawnPoint(${idx},'heading',this.value)" style="width: 70px;padding: 6px;" placeholder="Head" step="0.01">
</div>
<button class="btn btn-danger btn-small" onclick="removeSpawnPoint(${idx})" style="padding: 6px 10px;">âœ•</button>
</div>
`).join('');}function updateSpawnPoint(idx,field,value){if (spawnPoints[idx]){spawnPoints[idx][field] = parseFloat(value) || 0;}}function getPublicGarageLocation(){nuiPost('getCurrentPosition',{}).then(res => res.json()).then(pos =>{if (pos && pos.x !== undefined){document.getElementById('publicGarageX').value = pos.x.toFixed(2);document.getElementById('publicGarageY').value = pos.y.toFixed(2);document.getElementById('publicGarageZ').value = pos.z.toFixed(2);}}).catch(e =>{console.error('Error getting position:',e);});}function savePublicGarage(){const id = document.getElementById('publicGarageId').value.trim();const name = document.getElementById('publicGarageName').value.trim();const type = document.getElementById('publicGarageType').value;const radius = parseFloat(document.getElementById('publicGarageRadius').value) || 15;const x = parseFloat(document.getElementById('publicGarageX').value) || 0;const y = parseFloat(document.getElementById('publicGarageY').value) || 0;const z = parseFloat(document.getElementById('publicGarageZ').value) || 0;const blipSprite = parseInt(document.getElementById('publicGarageBlipSprite').value) || 357;const blipColor = parseInt(document.getElementById('publicGarageBlipColor').value) || 47;const blipScale = parseFloat(document.getElementById('publicGarageBlipScale').value) || 0.6;if (!id || !name){showConfirmModal('Error','Debes proporcionar un ID y nombre para el garaje','Entendido',() =>{});return;}if (!/^[a-zA-Z0-9_]+$/.test(id)){showConfirmModal('Error','El ID solo puede contener letras,nÃºmeros y guiones bajos','Entendido',() =>{});return;}if (!editingPublicGarageId){const exists = publicGarages.find(g => g.id === id);if (exists){showConfirmModal('Error','Ya existe un garaje con ese ID','Entendido',() =>{});return;}}const garageData ={id: id,name: name,type: type,garageType: 'public',radius: radius,coords:{x: x,y: y,z: z},spawnPoints: spawnPoints.map(sp => ({x: sp.x,y: sp.y,z: sp.z,heading: sp.heading})),blip:{sprite: blipSprite,color: blipColor,scale: blipScale}};if (editingPublicGarageId){const idx = publicGarages.findIndex(g => g.id === editingPublicGarageId);if (idx !== -1){publicGarages[idx] = garageData;}}else{publicGarages.push(garageData);}nuiPost('savePublicGarage',{garage: garageData,isEdit: !!editingPublicGarageId});renderPublicGarages();updatePublicGarageCount();closeCreatePublicGarageModal();const modalTitle = document.querySelector('#createPublicGarageModal .modal-title');if (modalTitle) modalTitle.textContent = 'Crear Garaje PÃºblico';}window.addEventListener('message',(event) =>{const data = event.data;if (data.action === 'openPublicGaragesAdmin'){if (data.locale && data.locale !== currentLocale){loadLocale(data.locale).then(() =>{openPublicGaragesAdmin(data.garages);});}else{openPublicGaragesAdmin(data.garages);}}if (data.action === 'updatePosition'){if (window._positionCallback){window._positionCallback(data);window._positionCallback = null;}}});let currentImpoundReleaseFee = 500;function openImpound(impound,vehicles,releaseFee,loading = false){currentImpound = impound;currentImpoundReleaseFee = releaseFee || 500;impoundVehicles = Array.isArray(vehicles) ? vehicles : [];selectedVehicle = null;isImpoundAdminView = false;isImpoundFullAdmin = false;document.getElementById('app').classList.remove('hidden');document.getElementById('garageMain').classList.add('hidden');document.getElementById('privateGaragesMain').classList.add('hidden');let impoundMain = document.getElementById('impoundMain');if (!impoundMain){impoundMain = createImpoundSection();document.getElementById('app').appendChild(impoundMain);}impoundMain.classList.remove('hidden');const impoundNameEl = document.getElementById('impoundName');const impoundFeeEl = document.getElementById('impoundReleaseFee');if (impoundNameEl) impoundNameEl.textContent = impound.name || 'Deposito';if (impoundFeeEl) impoundFeeEl.textContent = `$${releaseFee || 500}`;if (loading){showImpoundLoading();}else{renderImpoundVehicles(vehicles,releaseFee);updateImpoundVehicleCount();}}function showImpoundLoading(){const cont = document.getElementById('impoundVehiclesList');if (!cont) return;cont.innerHTML = `<div class="loading-state">
<div class="loading-spinner"></div>
<p>${LOCALE.loading || 'Cargando...'}</p>
</div>`;}function updateImpoundVehiclesList(vehicles,fullAdmin,adminView){impoundVehicles = Array.isArray(vehicles) ? vehicles : [];isImpoundFullAdmin = fullAdmin || false;isImpoundAdminView = adminView === true;renderImpoundVehicles(vehicles,currentImpoundReleaseFee);updateImpoundVehicleCount();}function createImpoundSection(){const section = document.createElement('section');section.id = 'impoundMain';section.className = 'garage-container';section.innerHTML = `
<div class="garage-header">
<div class="garage-header-left">
<div class="garage-icon impound-icon">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
<path d="M12 8v4M12 16h.01"/>
</svg>
</div>
<h1 class="garage-title" id="impoundName">Deposito</h1>
</div>
<div class="garage-header-right">
<button class="close-btn" onclick="closeUI()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
<path d="M18 6 6 18"/><path d="m6 6 12 12"/>
</svg>
</button>
</div>
</div>
<div class="garage-content" id="impoundVehiclesList"></div>
<div class="garage-footer">
<div class="garage-footer-info">
<span class="footer-icon">
<svg viewBox="0 0 512 512" style="width:16px;height:16px;fill:currentColor;">
<path d="M135.2 117.4L109.1 192H402.9l-26.1-74.6C372.3 104.6 360.2 96 346.6 96H165.4c-13.6 0-25.7 8.6-30.2 21.4zM39.6 196.8L74.8 96.3C88.3 57.8 124.6 32 165.4 32H346.6c40.8 0 77.1 25.8 90.6 64.3l35.2 100.5c23.2 9.6 39.6 32.5 39.6 59.2V400v48c0 17.7-14.3 32-32 32H448c-17.7 0-32-14.3-32-32V400H96v48c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32V400 256c0-26.7 16.4-49.6 39.6-59.2zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 32a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/>
</svg>
</span>
<span><span id="impoundVehicleCount">0</span> vehiculo(s) confiscados</span>
</div>
</div>
`;return section;}function renderImpoundVehicles(vehicles,releaseFee){const cont = document.getElementById('impoundVehiclesList');if (!cont) return;while (cont.firstChild) cont.removeChild(cont.firstChild);if (!Array.isArray(vehicles) || vehicles.length === 0){cont.innerHTML = `<div class="empty-state">
<div class="empty-state-icon">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
</svg>
</div>
<p>No hay vehiculos confiscados</p>
</div>`;return;}const fragment = document.createDocumentFragment();vehicles.forEach(v =>{const card = document.createElement('div');card.className = 'vehicle-card impound-card';let modelName = (v.label || v.modelName || v.model || 'Vehiculo').toString();if (/^-?\d+$/.test(modelName) || 
/^vehicle[#\-]?-?\d+$/i.test(modelName) ||
modelName.toLowerCase() === 'unknown' || 
modelName.toLowerCase() === 'vehicle' ||
modelName.toLowerCase() === 'nil' ||
modelName === 'null'){modelName = 'Vehiculo';}const plate = v.plate || 'SIN PLACA';const fee = v.fee || releaseFee || 500;const reason = v.reason || 'No especificada';const ownerName = v.ownerName || 'Desconocido';let timeInfo = '';if (v.release_date){const releaseDate = new Date(v.release_date);const now = new Date();const hoursLeft = Math.max(0,Math.ceil((releaseDate - now) / (1000 * 60 * 60)));timeInfo = `<span class="time-info">${hoursLeft}h restantes</span>`;}const imageUrl = (v.modelName || v.model) ? getVehicleImageUrl({modelName: v.modelName || v.model, model: v.model}) : getPlaceholderImageEscaped();const fallbackImageUrl = getPlaceholderImageEscaped();card.innerHTML = `
<div class="vehicle-card-header" onclick="toggleImpoundDetails(this.parentElement)">
<div class="vehicle-card-left">
<div class="vehicle-image-wrapper">
<img src="${imageUrl}" alt="" class="vehicle-thumbnail" 
onerror="this.onerror=null;this.src='${fallbackImageUrl}';" />
</div>
<div class="vehicle-info">
<h3 class="vehicle-name">${escapeHtml(modelName)}</h3>
<span class="vehicle-plate">${escapeHtml(plate)}</span>
</div>
</div>
<div class="vehicle-card-right">
<span class="impound-fee">$${fee}</span>
${timeInfo}<svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<polyline points="6 9 12 15 18 9"></polyline>
</svg>
</div>
</div>
<div class="vehicle-details" style="display: none;">
<div class="impound-info">
<div class="info-row">
<span class="label">Dueno:</span>
<span class="value">${escapeHtml(ownerName)}</span>
</div>
<div class="info-row">
<span class="label">Razon:</span>
<span class="value">${escapeHtml(reason)}</span>
</div>
<div class="info-row">
<span class="label">Fecha:</span>
<span class="value">${v.impoundedAt ? new Date(v.impoundedAt).toLocaleString() : 'Desconocido'}</span>
</div>
</div>
<div class="vehicle-actions">
${isImpoundAdminView ? `<button class="btn btn-success" onclick="policeReleaseFromImpound(${v.id},'${escapeHtml(plate)}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="9 12 12 15 16 9"></polyline><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Liberar Gratis</button>` : `<button class="btn btn-primary" onclick="releaseFromImpound(${v.id},'${escapeHtml(plate)}',${fee})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 12 15 16 9"></polyline></svg>Pagar y Liberar ($${fee})</button>`}
${isImpoundFullAdmin ? `<button class="btn btn-danger" onclick="deleteFromImpound(${v.id},'${escapeHtml(plate)}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>Eliminar del Sistema</button>` : ''}
</div>
</div>
`;fragment.appendChild(card);});cont.appendChild(fragment);}function updateImpoundVehicleCount(){const countEl = document.getElementById('impoundVehicleCount');if (countEl){countEl.textContent = impoundVehicles.length;}}function releaseFromImpound(vehicleId,plate,fee){showConfirmModal(
'Liberar Vehiculo',`Deseas pagar $${fee} para liberar este vehiculo del deposito?`,'Pagar y Liberar',() =>{closeConfirmModal();nuiPost('releaseFromImpound',{id: vehicleId,plate: plate,fee: fee});});}function policeReleaseFromImpound(vehicleId,plate){showConfirmModal(
'Liberar Vehiculo','Deseas liberar este vehiculo sin cobrar la tarifa? El vehiculo sera enviado al garaje del dueno.','Liberar Gratis',() =>{closeConfirmModal();nuiPost('policeReleaseFromImpound',{id: vehicleId,plate: plate});});}function deleteFromImpound(vehicleId,plate){showConfirmModal(
'Eliminar del Sistema','ADVERTENCIA: Esta accion eliminara permanentemente el vehiculo del sistema. El dueno perdera el vehiculo para siempre. Esta seguro?','Eliminar Permanentemente',() =>{closeConfirmModal();nuiPost('deleteFromImpound',{id: vehicleId,plate: plate});});}function openImpoundForm(data){impoundFormData = data;const modal = document.getElementById('impoundFormModal');if (!modal){console.error('Modal de incautaciÃ³n no encontrado');return;}document.getElementById('impoundVehicleInfo').value = data.modelName || 'Desconocido';document.getElementById('impoundPlate').value = data.plate || '';document.getElementById('impoundFee').value = data.defaultFee || 500;const locationSelect = document.getElementById('impoundLocation');locationSelect.innerHTML = '';(data.locations || []).forEach(loc =>{const opt = document.createElement('option');opt.value = loc.id;opt.textContent = loc.name;locationSelect.appendChild(opt);});const reasonSelect = document.getElementById('impoundReason');reasonSelect.innerHTML = '';(data.reasons || []).forEach(reason =>{const opt = document.createElement('option');opt.value = reason;opt.textContent = reason;reasonSelect.appendChild(opt);});document.getElementById('app').classList.remove('hidden');modal.classList.remove('hidden');}async function confirmImpoundForm(){if (!impoundFormData) return;const fee = parseInt(document.getElementById('impoundFee').value) || 500;const impoundId = document.getElementById('impoundLocation').value;const reason = document.getElementById('impoundReason').value;document.getElementById('impoundFormModal').classList.add('hidden');document.getElementById('app').classList.add('hidden');await nuiPost('confirmImpound',{plate: impoundFormData.plate,impoundId: impoundId,fee: fee,reason: reason,vehicleProps: impoundFormData.vehicleProps,netId: impoundFormData.netId});impoundFormData = null;}function cancelImpoundForm(){nuiPost('cancelImpound',{});document.getElementById('impoundFormModal')?.classList.add('hidden');document.getElementById('app').classList.add('hidden');impoundFormData = null;}window.openImpoundForm = openImpoundForm;window.confirmImpoundForm = confirmImpoundForm;window.cancelImpoundForm = cancelImpoundForm;window.policeReleaseFromImpound = policeReleaseFromImpound;window.deleteFromImpound = deleteFromImpound;window.openPublicGaragesAdmin = openPublicGaragesAdmin;window.closePublicGaragesAdmin = closePublicGaragesAdmin;window.openCreatePublicGarageModal = openCreatePublicGarageModal;window.closeCreatePublicGarageModal = closeCreatePublicGarageModal;window.editPublicGarage = editPublicGarage;window.deletePublicGarage = deletePublicGarage;window.teleportToPublicGarage = teleportToPublicGarage;window.savePublicGarage = savePublicGarage;window.addSpawnPoint = addSpawnPoint;window.addCurrentPositionAsSpawn = addCurrentPositionAsSpawn;window.removeSpawnPoint = removeSpawnPoint;window.updateSpawnPoint = updateSpawnPoint;window.getPublicGarageLocation = getPublicGarageLocation;